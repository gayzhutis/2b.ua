/*
 * jQuery File Upload User Interface Extended Plugin 4.6
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://creativecommons.org/licenses/MIT/
 */

/*jslint regexp: false, unparam: true */
/*global jQuery */

(function(a){"use strict";var c,b;if(typeof a().button!=="function")a.fn.button=function(b){return this.each(function(){if(b==="destroy")a(this).removeClass("ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only ui-button-text-icon-primary").html(a(this).text());else a(this).addClass("ui-button ui-widget ui-state-default ui-corner-all").addClass(b.text===false?"ui-button-icon-only":"ui-button-text-icon-primary").html(a('<span class="ui-button-text"/>').text(a(this).text())).prepend(a('<span class="ui-button-icon-primary ui-icon"/>').addClass(b.icons.primary))})};c=function(c,d){var b=this;this.locale={};this.maxFileSize=null;this.minFileSize=1;this.maxNumberOfFiles=null;this.acceptFileTypes=/.+$/i;this.autoUpload=false;this.forceIframeDownload=true;this.url=c.find("form:first").attr("action");this.dropZone=c.find("form:first");this.uploadTable=c.find(".files:first");this.downloadTable=this.uploadTable;this.progressAllNode=c.find(".file_upload_overall_progress div:first");this.uploadTemplate=this.uploadTable.find(".file_upload_template:first");this.downloadTemplate=this.uploadTable.find(".file_download_template:first");this.multiButtons=c.find(".file_upload_buttons:first");this.adjustMaxNumberOfFiles=function(b){var a=c.fileUploadUIX("option","maxNumberOfFiles");typeof a==="number"&&c.fileUploadUIX("option","maxNumberOfFiles",a+b)};this.formatFileSize=function(a){return typeof a!=="number"||a===null?"":a>=1e9?(a/1e9).toFixed(2)+" GB":a>=1e6?(a/1e6).toFixed(2)+" MB":(a/1e3).toFixed(2)+" KB"};this.formatFileName=function(a){return a.replace(/^.*[\/\\]/,"")};this.enableDragToDesktop=function(){var b=a(this),c=b.get(0).href,d=decodeURIComponent(c.split("/").pop()).replace(/:/g,"-"),e="application/octet-stream";b.bind("dragstart",function(a){try{a.originalEvent.dataTransfer.setData("DownloadURL",[e,d,c].join(":"))}catch(b){}})};this.buildMultiUploadRow=function(b,c){var d=a('<tbody style="display:none;"/>');a.each(b,function(e){var f=c.buildUploadRow(b,e,c).show(),a=f.find(".file_upload_progress, .file_upload_start, .file_upload_cancel");if(e)a.remove();else a.attr("rowspan",b.length);d.append(f)});return d};this.buildUploadRow=function(c,d,b){if(typeof d!=="number")return b.buildMultiUploadRow(c,b);var e=c[d],f=b.formatFileName(e.name),a=b.uploadTemplate.clone().removeAttr("id");a.find(".file_name").text(f);a.find(".file_size").text(b.formatFileSize(e.size));if(b.autoUpload)a.find(".file_upload_start button").hide();else a.find(".file_upload_start button").button({icons:{primary:"ui-icon-circle-arrow-e"},text:false});a.find(".file_upload_cancel button").button({icons:{primary:"ui-icon-cancel"},text:false});return a};this.getFileUrl=function(a){return a.url};this.getThumbnailUrl=function(a){return a.thumbnail};this.buildMultiDownloadRow=function(d,b){var c=a('<tbody style="display:none;"/>');a.each(d,function(d,a){c.append(b.buildDownloadRow(a,b).show())});return c};this.buildDownloadRow=function(d,b){if(a.isArray(d))return b.buildMultiDownloadRow(d,b);var f=b.formatFileName(d.name),g=b.getFileUrl(d,b),e=b.getThumbnailUrl(d,b),c=b.downloadTemplate.clone().removeAttr("id");c.attr("data-id",d.id||d.name);c.find(".file_name a").text(f);c.find(".file_size").text(b.formatFileSize(d.size));if(e){c.find(".file_download_preview").append(a("<a/>").append(a("<img/>").attr("src",e)));c.find("a").attr("target","_blank")}c.find("a").attr("href",g||null).each(b.enableDragToDesktop);c.find(".file_download_delete button").button({icons:{primary:"ui-icon-trash"},text:false});return c};this.onError=function(c,d,e,f,b){b.uploadRow.addClass("file_upload_error").find(".file_upload_progress").append(a('<div class="error"/>').append(b.locale[c]||c))};this.validate=function(h,c,d,g,b){var e=true,f;if(typeof d!=="number")a.each(c,function(a){e=b.validate(h,c,a,g,b)});else{f=c[d];if(b.maxFileSize&&f.size>b.maxFileSize){b.onError("File is too big",c,d,g,b);e=false}else if(typeof f.size==="number"&&f.size<b.minFileSize){b.onError("File is too small",c,d,g,b);e=false}if(!(b.acceptFileTypes.test(f.type)||b.acceptFileTypes.test(f.name))){b.onError("Filetype not allowed",c,d,g,b);e=false}if(typeof b.maxNumberOfFiles==="number"&&b.maxNumberOfFiles<d+1){b.onError("Max number exceeded",c,d,g,b);e=false}}return e};this.uploadCallBack=function(c,d,e,f,b,a){a()};this.beforeSend=function(e,c,d,f,b,g){if(!b.validate(e,c,d,f,b))return;var h=typeof d==="number"?1:c.length;b.adjustMaxNumberOfFiles(-h);b.uploadRow.find(b.cancelSelector).click(function(){b.adjustMaxNumberOfFiles(h)});if(b.autoUpload)b.uploadCallBack(e,c,d,f,b,g);else b.uploadRow.find(".file_upload_start button").click(function(h){a(this).fadeOut();b.uploadCallBack(e,c,d,f,b,g);h.preventDefault()})};this.downloadHandler=function(d){if(b.forceIframeDownload){a('<iframe style="display:none;"/>').attr("src",this.href).appendTo(c);d.preventDefault()}};this.deleteHandler=function(d){var c=a(this).closest("tr");a.ajax({url:b.url+"?file="+encodeURIComponent(c.attr("data-id")),type:"DELETE",success:function(){b.adjustMaxNumberOfFiles(1);c.fadeOut(function(){c.remove()})}});d.preventDefault()};this.initEventHandlers=function(){b.downloadTable.find('a:not([target="_blank"])').live("click",b.downloadHandler);b.downloadTable.find(".file_download_delete button").live("click",b.deleteHandler)};this.destroyEventHandlers=function(){b.downloadTable.find('a:not([target="_blank"])').die("click",b.downloadHandler);b.downloadTable.find(".file_download_delete button").die("click",b.deleteHandler)};this.multiButtonHandler=function(a){b.uploadTable.find(a.data.selector+" button:visible").click();a.preventDefault()};this.initMultiButtons=function(){if(b.autoUpload)b.multiButtons.find(".file_upload_start:first").hide();else b.multiButtons.find(".file_upload_start:first").button({icons:{primary:"ui-icon-circle-arrow-e"}}).bind("click",{selector:".file_upload_start"},b.multiButtonHandler);b.multiButtons.find(".file_upload_cancel:first").button({icons:{primary:"ui-icon-cancel"}}).bind("click",{selector:".file_upload_cancel"},b.multiButtonHandler);b.multiButtons.find(".file_download_delete:first").button({icons:{primary:"ui-icon-trash"}}).bind("click",{selector:".file_download_delete"},b.multiButtonHandler)};this.destroyMultiButtons=function(){b.multiButtons.find(".file_upload_start:first, .file_upload_cancel:first, .file_download_delete:first").unbind("click",b.multiButtonHandler).button("destroy").show()};this.initExtended=function(){b.initEventHandlers();b.initMultiButtons()};this.destroyExtended=function(){b.destroyEventHandlers();b.destroyMultiButtons()};a.extend(this,d)};b={init:function(b){return this.each(function(){a(this).fileUploadUI(new c(a(this),b))})},option:function(b,c,d){return!b||typeof b==="string"&&typeof c==="undefined"?a(this).fileUpload("option",b,c,d):this.each(function(){a(this).fileUploadUI("option",b,c,d)})},destroy:function(b){return this.each(function(){a(this).fileUploadUI("destroy",b)})},upload:function(c,b){return this.each(function(){a(this).fileUploadUI("upload",c,b)})}};a.fn.fileUploadUIX=function(c){if(b[c])return b[c].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof c==="object"||!c)return b.init.apply(this,arguments);else a.error('Method "'+c+'" does not exist on jQuery.fileUploadUIX')}})(jQuery)