/*
 * jQuery File Upload User Interface Plugin 4.4.1
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://creativecommons.org/licenses/MIT/
 */

/*jslint browser: true, unparam: true */
/*global jQuery, FileReader, URL, webkitURL */

(function(b){"use strict";var c="undefined",a="function",e,d,f=function(c){var b=0,a=[];this.complete=function(){b+=1;if(b===a.length+1){c(a);b=0;a=[]}};this.push=function(b){a.push(b)};this.getList=function(){return a}};e=function(k,l){var d=this,e,g,i=new f(function(b){d.hideProgressBarAll(function(){d.resetProgressBarAll();if(typeof d.onCompleteAll===a)d.onCompleteAll(b)})}),h=function(b){return typeof b.uploadTable===a?b.uploadTable(b):b.uploadTable},j=function(b){return typeof b.downloadTable===a?b.downloadTable(b):b.downloadTable};this.requestHeaders={Accept:"application/json, text/javascript, */*; q=0.01"};this.dropZone=k;this.imageTypes=/^image\/(gif|jpeg|png)$/;this.previewMaxWidth=this.previewMaxHeight=80;this.previewLoadDelay=100;this.previewAsCanvas=true;this.previewSelector=".file_upload_preview";this.progressSelector=".file_upload_progress div";this.cancelSelector=".file_upload_cancel button";this.cssClassSmall="file_upload_small";this.cssClassLarge="file_upload_large";this.cssClassHighlight="file_upload_highlight";this.dropEffect="highlight";this.uploadTable=this.downloadTable=null;this.buildUploadRow=this.buildDownloadRow=null;this.progressAllNode=null;this.loadImage=function(h,g,k,j,i,l){var b,f,d,e;if(i&&!i.test(h.type))return null;f=function(b){var c=document.createElement("canvas"),d=Math.min((k||b.width)/b.width,(j||b.height)/b.height);if(d>1)d=1;b.width=parseInt(b.width*d,10);b.height=parseInt(b.height*d,10);if(l||typeof c.getContext!==a)return b;c.width=b.width;c.height=b.height;c.getContext("2d").drawImage(b,0,0,b.width,b.height);return c};b=document.createElement("img");d=typeof URL!==c?URL:typeof webkitURL!==c?webkitURL:null;if(d&&typeof d.createObjectURL===a){b.onload=function(){d.revokeObjectURL(this.src);g(f(b))};b.src=d.createObjectURL(h)}else if(typeof FileReader!==c&&typeof FileReader.prototype.readAsDataURL===a){b.onload=function(){g(f(b))};e=new FileReader;e.onload=function(a){b.src=a.target.result};e.readAsDataURL(h)}else g(null)};this.addNode=function(d,c,b){if(d&&d.length&&c&&c.length)c.css("display","none").appendTo(d).fadeIn(function(){if(typeof b===a)try{b()}catch(d){c.stop();throw d;}});else typeof b===a&&b()};this.removeNode=function(b,c){if(b&&b.length)b.fadeOut(function(){b.remove();if(typeof c===a)try{c()}catch(d){b.stop();throw d;}});else typeof c===a&&c()};this.replaceNode=function(c,b,e){if(!(b&&b.length))return d.removeNode(c,e);if(c&&c.length)c.fadeOut(function(){b.css("display","none");c.replaceWith(b);b.fadeIn(function(){if(typeof e===a)try{e()}catch(d){c.stop();b.stop();throw d;}})});else typeof e===a&&e()};this.resetProgressBarAll=function(){d.progressbarAll&&d.progressbarAll.progressbar("value",0)};this.hideProgressBarAll=function(c){if(d.progressbarAll&&!b(h(d)).find(d.progressSelector+":visible:first").length)d.progressbarAll.fadeOut(c);else typeof c===a&&c()};this.onAbort=function(b,c,d,e,a){a.removeNode(a.uploadRow,a.hideProgressBarAll)};this.cancelUpload=function(d,e,f,a,c){var b=a.readyState;a.abort();if(typeof b!=="number"||b<2)c.onAbort(d,e,f,a,c)};this.initProgressBar=function(c,d){if(!c||!c.length)return null;if(typeof c.progressbar===a)return c.progressbar({value:d});else{c.addClass("progressbar").append(b("<div/>").css("width",d+"%")).progressbar=function(c,a){return this.each(function(){if(c==="destroy")b(this).removeClass("progressbar").empty();else b(this).children().css("width",a+"%")})};return c}};this.destroyProgressBar=function(a){return!a||!a.length?null:a.progressbar("destroy")};this.initUploadProgress=function(b,a){!b.upload&&a.progressbar&&a.progressbar.progressbar("value",100)};this.initUploadProgressAll=function(){d.progressbarAll&&d.progressbarAll.is(":hidden")&&d.progressbarAll.fadeIn()};this.onSend=function(c,d,e,b,a){a.initUploadProgress(b,a)};this.onProgress=function(a,c,d,e,b){b.progressbar&&a.lengthComputable&&b.progressbar.progressbar("value",parseInt(a.loaded/a.total*100,10))};this.onProgressAll=function(a){d.progressbarAll&&a.lengthComputable&&d.progressbarAll.progressbar("value",parseInt(a.loaded/a.total*100,10))};this.onLoadAll=function(){i.complete()};this.initProgressBarAll=function(){if(!d.progressbarAll)d.progressbarAll=d.initProgressBar(typeof d.progressAllNode===a?d.progressAllNode(d):d.progressAllNode,0)};this.destroyProgressBarAll=function(){d.destroyProgressBar(d.progressbarAll)};this.loadPreviewImage=function(d,c,a){c=c||0;a.uploadRow.find(a.previewSelector).each(function(){var e=b(this),f=d[c];setTimeout(function(){a.loadImage(f,function(c){a.addNode(e,b(c))},a.previewMaxWidth,a.previewMaxHeight,a.imageTypes,!a.previewAsCanvas)},a.previewLoadDelay);c+=1})};this.initUploadRow=function(g,d,e,f,b){var c=b.uploadRow=typeof b.buildUploadRow===a?b.buildUploadRow(d,e,b):null;if(c){b.progressbar=b.initProgressBar(c.find(b.progressSelector),0);c.find(b.cancelSelector).click(function(a){b.cancelUpload(a,d,e,f,b);a.preventDefault()});b.loadPreviewImage(d,e,b)}};this.initUpload=function(d,e,f,g,b,c){b.initUploadRow(d,e,f,g,b);b.addNode(h(b),b.uploadRow,function(){if(typeof b.beforeSend===a)b.beforeSend(d,e,f,g,b,c);else c()});b.initUploadProgressAll()};this.parseResponse=function(a){return typeof a.responseText!==c?b.parseJSON(a.responseText):b.parseJSON(a.contents().text())};this.initDownloadRow=function(f,g,h,d,b){var c,e;try{c=b.response=b.parseResponse(d,b)}catch(i){if(typeof b.onError===a){b.originalEvent=f;b.onError(i,g,h,d,b)}else throw i;}e=b.downloadRow=typeof b.buildDownloadRow===a?b.buildDownloadRow(c,b):null};this.onLoad=function(f,g,k,l,b){var d=h(b),c=j(b),e=function(){if(typeof b.onComplete===a)b.onComplete(f,g,k,l,b);i.complete()};i.push(Array.prototype.slice.call(arguments,1));b.initDownloadRow(f,g,k,l,b);if(d&&b.uploadRow&&b.uploadRow.length&&(!c||d.get(0)===c.get(0)))b.replaceNode(b.uploadRow,b.downloadRow,e);else b.removeNode(b.uploadRow,function(){b.addNode(c,b.downloadRow,e)})};this.dropZoneEnlarge=function(){if(!g){if(typeof d.dropZone.switchClass===a)d.dropZone.switchClass(d.cssClassSmall,d.cssClassLarge);else{d.dropZone.addClass(d.cssClassLarge);d.dropZone.removeClass(d.cssClassSmall)}g=true}};this.dropZoneReduce=function(){if(typeof d.dropZone.switchClass===a)d.dropZone.switchClass(d.cssClassLarge,d.cssClassSmall);else{d.dropZone.addClass(d.cssClassSmall);d.dropZone.removeClass(d.cssClassLarge)}g=false};this.onDocumentDragEnter=function(){d.dropZoneEnlarge()};this.onDocumentDragOver=function(){e&&clearTimeout(e);e=setTimeout(function(){d.dropZoneReduce()},200)};this.onDragEnter=this.onDragLeave=function(){d.dropZone.toggleClass(d.cssClassHighlight)};this.onDrop=function(){e&&clearTimeout(e);if(d.dropEffect&&typeof d.dropZone.effect===a)d.dropZone.effect(d.dropEffect,function(){d.dropZone.removeClass(d.cssClassHighlight);d.dropZoneReduce()});else{d.dropZone.removeClass(d.cssClassHighlight);d.dropZoneReduce()}};this.init=function(){d.initProgressBarAll();typeof d.initExtended===a&&d.initExtended()};this.destroy=function(){typeof d.destroyExtended===a&&d.destroyExtended();d.destroyProgressBarAll()};b.extend(this,l)};d={init:function(a){return this.each(function(){b(this).fileUpload(new e(b(this),a))})},option:function(a,d,e){return!a||typeof a==="string"&&typeof d===c?b(this).fileUpload("option",a,d,e):this.each(function(){b(this).fileUpload("option",a,d,e)})},destroy:function(a){return this.each(function(){b(this).fileUpload("destroy",a)})},upload:function(c,a){return this.each(function(){b(this).fileUpload("upload",c,a)})}};b.fn.fileUploadUI=function(a){if(d[a])return d[a].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof a==="object"||!a)return d.init.apply(this,arguments);else b.error('Method "'+a+'" does not exist on jQuery.fileUploadUI')}})(jQuery)